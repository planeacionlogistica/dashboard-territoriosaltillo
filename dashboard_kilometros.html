<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Kil√≥metros | Traxi√≥n</title>

<!-- ================== CDN ================== -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ================== ESTILOS ================== -->
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family:'Segoe UI',Tahoma,Verdana,sans-serif;
    background:#f3f4f6;
    color:#1f2937;
    min-height:100vh;
}

/* ===== NAVEGACI√ìN ===== */
nav{
    background:#1f2937;
    padding:15px 30px;
    display:flex;
    gap:25px;
    align-items:center;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
}
nav a{
    color:#e5e7eb;
    text-decoration:none;
    font-weight:600;
    padding:8px 16px;
    border-radius:8px;
    transition:all 0.3s;
}
nav a:first-child{
    color:#84cc16;
    font-weight:800;
    font-size:18px;
}
nav a:hover{
    background:#374151;
}
nav a.active{
    background:#84cc16;
    color:#1f2937;
}

/* ===== CONTENIDO ===== */
.content{
    padding:30px;
    max-width:1600px;
    margin:0 auto;
}

header{
    background:linear-gradient(135deg,#1f2937,#374151);
    padding:30px;
    border-radius:14px;
    margin-bottom:20px;
}
header h1{
    color:#84cc16;
    font-size:32px;
    margin-bottom:8px;
}
.subtitle{
    color:#d1d5db;
    font-size:16px;
}

.filter-bar{
    margin:0 0 20px 0;
}
.filter-bar select{
    padding:12px 16px;
    border-radius:10px;
    border:2px solid #e5e7eb;
    font-size:15px;
    font-weight:600;
    min-width:250px;
    background:#ffffff;
    cursor:pointer;
    transition:border 0.3s;
}
.filter-bar select:focus{
    outline:none;
    border-color:#84cc16;
}

.kpi-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
    gap:18px;
    margin-bottom:25px;
}

.kpi-card{
    background:#ffffff;
    border:2px solid #e5e7eb;
    border-radius:12px;
    padding:20px;
    transition:transform 0.2s, box-shadow 0.2s;
}
.kpi-card:hover{
    transform:translateY(-2px);
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
}
.kpi-card.highlight{
    border-left:5px solid #84cc16;
}
.kpi-card.warning{
    border-left:5px solid #f59e0b;
}
.kpi-card.danger{
    border-left:5px solid #ef4444;
}

.kpi-label{
    font-size:11px;
    font-weight:700;
    color:#6b7280;
    text-transform:uppercase;
    letter-spacing:0.5px;
    margin-bottom:8px;
}
.kpi-value{
    font-size:28px;
    font-weight:800;
    color:#1f2937;
    margin:8px 0;
}
.kpi-value.highlight{
    color:#84cc16;
}
.kpi-value.danger{
    color:#ef4444;
}
.kpi-subvalue{
    font-size:12px;
    color:#9ca3af;
    margin-top:6px;
    line-height:1.4;
}

.chart-row{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(400px, 1fr));
    gap:20px;
    margin-bottom:25px;
}

.chart-container{
    background:#ffffff;
    border:2px solid #e5e7eb;
    border-radius:12px;
    padding:20px;
    transition:transform 0.2s, box-shadow 0.2s;
}
.chart-container:hover{
    transform:translateY(-2px);
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
}
.chart-container h3{
    font-size:16px;
    font-weight:700;
    margin-bottom:15px;
    color:#1f2937;
    padding-bottom:10px;
    border-bottom:2px solid #84cc16;
}
canvas{
    max-height:280px;
}

table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
}
th,td{
    padding:10px;
    text-align:left;
    border-bottom:1px solid #e5e7eb;
}
th{
    background:#f9fafb;
    font-weight:700;
    color:#374151;
}
tr:hover{
    background:#f9fafb;
}
.highlight-row{
    background:#fef3c7 !important;
}

button{
    background:#84cc16;
    color:#1f2937;
    border:none;
    padding:10px 20px;
    border-radius:8px;
    font-weight:700;
    font-size:14px;
    cursor:pointer;
    transition:all 0.3s;
    box-shadow:0 2px 4px rgba(0,0,0,0.1);
}
button:hover{
    background:#65a30d;
}

input[type="text"]{
    padding:8px;
    border:2px solid #e5e7eb;
    border-radius:6px;
    font-size:13px;
}
input[type="text"]:focus{
    outline:none;
    border-color:#84cc16;
}

@media (max-width: 1024px){
    .kpi-grid{
        grid-template-columns:repeat(2, 1fr);
    }
    .chart-row{
        grid-template-columns:1fr;
    }
}

@media (max-width: 640px){
    nav{
        flex-wrap:wrap;
        gap:10px;
    }
    .content{
        padding:15px;
    }
    header{
        padding:20px;
    }
    header h1{
        font-size:24px;
    }
    .kpi-grid{
        grid-template-columns:1fr;
    }
    .kpi-value{
        font-size:24px;
    }
    .filter-bar select{
        width:100%;
    }
}
</style>
</head>

<body>

<!-- ================== NAVEGACI√ìN ================== -->
<nav>
    <a href="index.html">üöõ TRAXI√ìN</a>
    <a href="dashboard_kilometros.html" class="active">üìä Kil√≥metros</a>
    <a href="dashboard_flota.html">üöó Flota</a>
    <a href="dashboard_scoreseg.html">üõ°Ô∏è ScoreSeg</a>
</nav>

<!-- ================== CONTENIDO ================== -->
<main class="content">

    <header>
        <h1>Dashboard de Kil√≥metros Recorridos</h1>
        <p class="subtitle" id="headerPeriodo">Cargando datos...</p>
    </header>

    <div class="filter-bar">
        <select id="unidadNegocio">
            <option value="SETTEPI SALTILLO">SETTEPI SALTILLO</option>
            <option value="LIPU SALTILLO">LIPU SALTILLO</option>
        </select>
    </div>

    <!-- KPIs -->
    <div class="kpi-grid">
        <div class="kpi-card highlight">
            <div class="kpi-label">Total KM Recorridos</div>
            <div class="kpi-value highlight" id="kpiTotal">0 km</div>
            <div class="kpi-subvalue">Acumulado del periodo</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">KM Permitidos</div>
            <div class="kpi-value" id="kpiPermitido">0 km</div>
            <div class="kpi-subvalue">L√≠mite establecido</div>
        </div>

        <div class="kpi-card" id="cardMargen">
            <div class="kpi-label">Margen Disponible</div>
            <div class="kpi-value" id="kpiMargen">0 km</div>
            <div class="kpi-subvalue" id="txtMargen">Calculando...</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">KM de Servicio</div>
            <div class="kpi-value" id="kpiServicio">0 km</div>
            <div class="kpi-subvalue" id="pctServicio">0% del total</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">KM Mtto / Carga / RH / Seg</div>
            <div class="kpi-value" id="kpiMtto">0 km</div>
            <div class="kpi-subvalue" id="pctMtto">0% del total</div>
        </div>

        <div class="kpi-card warning">
            <div class="kpi-label">KM Ineficiente (Vac√≠o)</div>
            <div class="kpi-value" id="kpiVacio">0 km</div>
            <div class="kpi-subvalue" id="pctVacio">0% del total</div>
        </div>
    </div>

    <!-- Gr√°ficas -->
    <div class="chart-row">
        <div class="chart-container">
            <h3>KM Recorridos vs Permitido por D√≠a</h3>
            <canvas id="chartProgreso"></canvas>
        </div>

        <div class="chart-container">
            <h3>Distribuci√≥n Total (%)</h3>
            <canvas id="chartDistribucion"></canvas>
        </div>

        <div class="chart-container">
            <h3>Comportamiento Diario</h3>
            <canvas id="chartDiario"></canvas>
        </div>
    </div>

    <!-- Tabla de Detalle por Cliente -->
    <div class="chart-container" style="margin-bottom:25px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px;">
            <h3 style="margin:0;">Detalle por Cliente</h3>
            <button id="btnExportarCliente">üì• Exportar a Excel</button>
        </div>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:15px;">
            <input type="text" id="filtroGerente" placeholder="üîç Filtrar Gerente">
            <input type="text" id="filtroJefe" placeholder="üîç Filtrar Jefe">
            <input type="text" id="filtroCliente" placeholder="üîç Filtrar Cliente">
            <button id="btnLimpiarCliente">üóëÔ∏è Limpiar</button>
        </div>
        
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>Unidad de Negocio</th>
                        <th>Gerente de OP</th>
                        <th>Jefe de OP</th>
                        <th>Cliente</th>
                        <th>KM Recorridos</th>
                        <th>KM de Servicios</th>
                        <th>KM Mtto/Carga/RH/Seg</th>
                        <th>KM Ineficiente</th>
                        <th>% Vac√≠o</th>
                    </tr>
                </thead>
                <tbody id="tablaDetalle"></tbody>
            </table>
        </div>
    </div>

    <!-- Tabla de Detalle por Carro -->
    <div class="chart-container">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px;">
            <h3 style="margin:0;">Detalle por Unidad (Carro)</h3>
            <button id="btnExportarCarro">üì• Exportar a Excel</button>
        </div>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:15px;">
            <input type="text" id="filtroEconomico" placeholder="üîç Filtrar Econ√≥mico">
            <input type="text" id="filtroGerenteCarro" placeholder="üîç Filtrar Gerente">
            <input type="text" id="filtroJefeCarro" placeholder="üîç Filtrar Jefe">
            <button id="btnLimpiarCarro">üóëÔ∏è Limpiar</button>
        </div>
        
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>Econ√≥mico</th>
                        <th>Gerente de OP</th>
                        <th>Jefe de OP</th>
                        <th>KM Recorridos</th>
                        <th>KM de Servicios</th>
                        <th>KM Mtto/Carga/RH/Seg</th>
                        <th>KM Ineficiente</th>
                        <th>% Vac√≠o</th>
                    </tr>
                </thead>
                <tbody id="tablaCarro"></tbody>
            </table>
        </div>
    </div>

</main>

<!-- ================== JAVASCRIPT ================== -->
<script>
const SHEET_ID = "1l3QYg7N050BScrtNhKkHQ-hHNDgaK9Prw95Dzb2-DRE";
const SHEET_NAME = "Kilometros";

function num(v){
    if(!v) return 0;
    let str = v.toString().replace(/[$,\s]/g,"").trim();
    return Number(str) || 0;
}

function formatearNumero(n){
    return n.toLocaleString('en-US', {minimumFractionDigits:1, maximumFractionDigits:1});
}

async function cargarDatos(){
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&sheet=${SHEET_NAME}`;
    const res = await fetch(url);
    const csv = await res.text();
    return new Promise(r=>{
        Papa.parse(csv,{header:false,skipEmptyLines:true,complete:x=>r(x.data)});
    });
}

let chartProgreso, chartDistribucion, chartDiario;
let todasLasFilas = [];
let todasLasFilasCarro = [];

async function actualizar(){
    const unidad = unidadNegocio.value.trim();
    const rows = await cargarDatos();

    const hoy = new Date();
    const diaActual = hoy.getDate() - 1;

    console.log('üìÑ INICIANDO ACTUALIZACI√ìN');
    console.log('Unidad seleccionada:', unidad);
    console.log('Filas cargadas del Excel:', rows.length);

    let total=0, servicio=0, mtto=0, vacio=0, permitidoTotal=0;
    
    if(rows.length > 6){
        if(unidad === "SETTEPI SALTILLO"){
            permitidoTotal = num(rows[6][28]);
        } else {
            permitidoTotal = num(rows[6][29]);
        }
    }

    for(let i = 1; i < rows.length; i++){
        const r = rows[i];
        const udnRow = (r[0]||"").toString().trim().toUpperCase();
        
        if(udnRow.includes("SETTEPI") && unidad === "SETTEPI SALTILLO"){
            total += num(r[4]);
            servicio += num(r[5]);
            mtto += num(r[6]);
            vacio += num(r[7]);
        }
        else if(udnRow.includes("LIPU") && unidad === "LIPU SALTILLO"){
            total += num(r[4]);
            servicio += num(r[5]);
            mtto += num(r[6]);
            vacio += num(r[7]);
        }
    }

    let datosDiarios = [];

    for(let idx = 1; idx < rows.length; idx++){
        const r = rows[idx];
        
        let dia=0, kmTotal=0, kmServ=0, kmMtto=0, kmVac=0, kmPermDiario=0;
        let encontrado = false;
        
        if(unidad === "SETTEPI SALTILLO"){
            const udnSettepi = (r[11]||"").toString().trim().toUpperCase();
            
            if(udnSettepi === "SETTEPI" || udnSettepi.includes("SETTEPI")){
                dia = num(r[12]);
                kmTotal = num(r[13]);
                kmServ  = num(r[14]);
                kmMtto  = num(r[15]);
                kmVac   = num(r[16]);
                kmPermDiario = num(r[17]);
                encontrado = true;
            }
        } else {
            const udnLipu = (r[19]||"").toString().trim().toUpperCase();
            
            if(udnLipu === "LIPU" || udnLipu.includes("LIPU")){
                dia = num(r[20]);
                kmTotal = num(r[21]);
                kmServ  = num(r[22]);
                kmMtto  = num(r[23]);
                kmVac   = num(r[24]);
                kmPermDiario = num(r[25]);
                encontrado = true;
            }
        }
        
        if(encontrado && dia >= 1 && dia <= diaActual){
            datosDiarios.push({dia, kmTotal, kmServ, kmMtto, kmVac, kmPermDiario});
        }
    }

    console.log(`Datos diarios encontrados: ${datosDiarios.length} d√≠as`);

    kpiTotal.innerText = formatearNumero(total)+" km";
    kpiServicio.innerText = formatearNumero(servicio)+" km";
    kpiMtto.innerText = formatearNumero(mtto)+" km";
    kpiVacio.innerText = formatearNumero(vacio)+" km";
    kpiPermitido.innerText = formatearNumero(permitidoTotal)+" km";

    const pctServ = total > 0 ? ((servicio/total)*100).toFixed(1) : 0;
    const pctMt = total > 0 ? ((mtto/total)*100).toFixed(1) : 0;
    const pctVac = total > 0 ? ((vacio/total)*100).toFixed(1) : 0;

    pctServicio.innerText = pctServ + "% del total";
    pctMtto.innerText = pctMt + "% del total";
    pctVacio.innerText = pctVac + "% del total";

    // CORRECCI√ìN: margen ahora es permitido - recorrido (negativo = mal, positivo = bien)
    const margen = permitidoTotal - total;
    const cardMargen = document.getElementById('cardMargen');
    const valorMargen = document.getElementById('kpiMargen');
    
    // Si el margen es negativo (nos pasamos), mostrar en rojo y como positivo
    if(margen < 0){
        cardMargen.className = 'kpi-card danger';
        valorMargen.className = 'kpi-value danger';
        valorMargen.innerText = formatearNumero(Math.abs(margen))+" km";
    } else {
        // Si el margen es positivo (nos sobr√≥), mostrar en verde
        cardMargen.className = 'kpi-card highlight';
        valorMargen.className = 'kpi-value highlight';
        valorMargen.innerText = formatearNumero(margen)+" km";
    }

    const pctMargen = permitidoTotal > 0 ? ((Math.abs(margen)/permitidoTotal)*100).toFixed(1) : 0;
    const importe = (Math.abs(margen)*6).toLocaleString("es-MX",{style:"currency",currency:"MXN",minimumFractionDigits:1,maximumFractionDigits:1});
    
    if(margen < 0){
        txtMargen.innerHTML = `‚ö†Ô∏è EXCEDIDO ${pctMargen}% de los KM permitidos<br>Costo adicional: ${importe}`;
    } else {
        txtMargen.innerHTML = `‚úì Disponible ${pctMargen}% de los KM permitidos<br>Ahorro potencial: ${importe}`;
    }

    headerPeriodo.innerText = `Periodo al d√≠a ${diaActual} - ${unidad}`;

    // Construir tabla por CLIENTE
    const tablaBody = document.getElementById('tablaDetalle');
    tablaBody.innerHTML = '';
    
    let filasFiltradas = [];
    
    for(let i = 1; i < rows.length; i++){
        const r = rows[i];
        if(!r || r.length < 9) continue;
        
        const udnRow = (r[0]||"").toString().trim();
        const udnUpper = udnRow.toUpperCase();
        let coincide = false;
        
        if(unidad === "SETTEPI SALTILLO"){
            coincide = udnUpper.includes("SETTEPI");
        } else if(unidad === "LIPU SALTILLO"){
            coincide = udnUpper.includes("LIPU");
        }
        
        if(coincide){
            filasFiltradas.push({
                udn: udnRow,
                gerente: r[1]||"-",
                jefe: r[2]||"-",
                cliente: r[3]||"-",
                kmRecorridos: num(r[4]),
                kmServicios: num(r[5]),
                kmMtto: num(r[6]),
                kmIneficiente: num(r[7]),
                pctVacio: (r[8]||"0%").toString()
            });
        }
    }
    
    if(filasFiltradas.length > 0){
        filasFiltradas.sort((a,b)=>{
            const pctA = parseFloat(a.pctVacio.replace('%','').replace(',','.')) || 0;
            const pctB = parseFloat(b.pctVacio.replace('%','').replace(',','.')) || 0;
            return pctB - pctA;
        });
        
        todasLasFilas = filasFiltradas;
        renderizarTabla(filasFiltradas);
    } else {
        tablaBody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:20px;color:#6b7280;">No se encontraron registros para esta UDN</td></tr>';
        todasLasFilas = [];
    }

    // Construir tabla por CARRO (econ√≥mico)
    const tablaBodyCarro = document.getElementById('tablaCarro');
    tablaBodyCarro.innerHTML = '';
    
    let filasCarros = [];
    
    // Datos por CARRO desde el Excel
    // AF=31, AG=32, AH=33, AI=34, AJ=35, AK=36, AL=37, AM=38, AN=39
    for(let i = 1; i < rows.length; i++){
        const r = rows[i];
        if(!r || r.length < 40) continue;
        
        const udnCarro = (r[31]||"").toString().trim();
        const udnCarroUpper = udnCarro.toUpperCase();
        
        // Filtrar por unidad de negocio (igual que tabla de clientes)
        let coincide = false;
        if(unidad === "SETTEPI SALTILLO"){
            coincide = udnCarroUpper.includes("SETTEPI");
        } else if(unidad === "LIPU SALTILLO"){
            coincide = udnCarroUpper.includes("LIPU");
        }
        
        if(coincide){
            const gerenteCarro = r[32]||"-";
            const jefeCarro = r[33]||"-";
            const economico = (r[34]||"").toString().trim();
            
            // Solo agregar si tiene un econ√≥mico v√°lido
            if(economico && economico !== "" && economico !== "-"){
                filasCarros.push({
                    economico: economico,
                    gerente: gerenteCarro,
                    jefe: jefeCarro,
                    kmRecorridos: num(r[35]),
                    kmServicios: num(r[36]),
                    kmMtto: num(r[37]),
                    kmIneficiente: num(r[38]),
                    pctVacio: (r[39]||"0%").toString()
                });
            }
        }
    }
    
    if(filasCarros.length > 0){
        filasCarros.sort((a,b)=>{
            const pctA = parseFloat(a.pctVacio.replace('%','').replace(',','.')) || 0;
            const pctB = parseFloat(b.pctVacio.replace('%','').replace(',','.')) || 0;
            return pctB - pctA;
        });
        
        todasLasFilasCarro = filasCarros;
        renderizarTablaCarro(filasCarros);
    } else {
        tablaBodyCarro.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;color:#6b7280;">No se encontraron registros de carros para esta UDN</td></tr>';
        todasLasFilasCarro = [];
    }

    // Gr√°fica 1: Progreso
    datosDiarios.sort((a,b)=>a.dia-b.dia);

    let labels=[];
    let realDiario=[], perDiario=[];

    datosDiarios.forEach(d=>{
        labels.push("D√≠a "+d.dia);
        realDiario.push(d.kmTotal);
        perDiario.push(d.kmPermDiario);
    });

    if(chartProgreso) chartProgreso.destroy();
    
    if(labels.length > 0){
        chartProgreso = new Chart(document.getElementById("chartProgreso"),{
            type:"line",
            data:{
                labels,
                datasets:[
                    {
                        label:"KM Recorridos",
                        data:realDiario,
                        borderColor:"#84cc16",
                        backgroundColor:"rgba(132,204,22,0.2)",
                        borderWidth:3,
                        tension:0.3,
                        fill:true,
                        pointRadius:6,
                        pointBackgroundColor:"#84cc16",
                        pointBorderColor:"#fff",
                        pointBorderWidth:2
                    },
                    {
                        label:"KM Permitido",
                        data:perDiario,
                        borderColor:"#1f2937",
                        backgroundColor:"rgba(31,41,55,0.1)",
                        borderWidth:3,
                        tension:0.3,
                        fill:false,
                        pointRadius:6,
                        pointBackgroundColor:"#1f2937",
                        pointBorderColor:"#fff",
                        pointBorderWidth:2,
                        borderDash:[8,4]
                    }
                ]
            },
            options:{
                responsive:true,
                maintainAspectRatio:true,
                plugins:{
                    legend:{
                        display:true,
                        position:'top',
                        labels:{font:{size:12,weight:'bold'}}
                    }
                },
                scales:{
                    y:{
                        beginAtZero:true,
                        grid:{color:'rgba(0,0,0,0.05)'}
                    },
                    x:{
                        grid:{display:false}
                    }
                }
            }
        });
    }

    // Gr√°fica 2: Distribuci√≥n
    const pctServTotal = total > 0 ? ((servicio/total)*100).toFixed(1) : 0;
    const pctMttoTotal = total > 0 ? ((mtto/total)*100).toFixed(1) : 0;
    const pctVacTotal = total > 0 ? ((vacio/total)*100).toFixed(1) : 0;

    if(chartDistribucion) chartDistribucion.destroy();
    chartDistribucion = new Chart(document.getElementById("chartDistribucion"),{
        type:"doughnut",
        data:{
            labels:[
                `Servicio (${pctServTotal}%)`,
                `Mtto (${pctMttoTotal}%)`,
                `Vac√≠o (${pctVacTotal}%)`
            ],
            datasets:[{
                data:[servicio, mtto, vacio],
                backgroundColor:["#84cc16","#f59e0b","#ef4444"],
                borderWidth:3,
                borderColor:"#ffffff",
                hoverOffset:10
            }]
        },
        options:{
            responsive:true,
            maintainAspectRatio:true,
            plugins:{
                legend:{
                    display:true,
                    position:'bottom',
                    labels:{font:{size:12,weight:'bold'},padding:15}
                },
                tooltip:{
                    callbacks:{
                        label: function(context){
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            return label + ': ' + value.toLocaleString() + ' km';
                        }
                    }
                }
            },
            cutout:'60%'
        }
    });

    // Gr√°fica 3: Comportamiento
    let servDiario=[], mttoDiario=[], vacioDiario=[];
    datosDiarios.forEach(d=>{
        servDiario.push(d.kmServ);
        mttoDiario.push(d.kmMtto);
        vacioDiario.push(d.kmVac);
    });

    if(chartDiario) chartDiario.destroy();
    chartDiario = new Chart(document.getElementById("chartDiario"),{
        type:"line",
        data:{
            labels,
            datasets:[
                {
                    label:"Servicio",
                    data:servDiario,
                    borderColor:"#84cc16",
                    backgroundColor:"rgba(132,204,22,0.15)",
                    borderWidth:2.5,
                    tension:0.3,
                    fill:true,
                    pointRadius:4,
                    pointBackgroundColor:"#84cc16"
                },
                {
                    label:"Mtto",
                    data:mttoDiario,
                    borderColor:"#6b7280",
                    backgroundColor:"rgba(107,114,128,0.15)",
                    borderWidth:2.5,
                    tension:0.3,
                    fill:true,
                    pointRadius:4,
                    pointBackgroundColor:"#6b7280"
                },
                {
                    label:"Vac√≠o",
                    data:vacioDiario,
                    borderColor:"#ef4444",
                    backgroundColor:"rgba(239,68,68,0.15)",
                    borderWidth:2.5,
                    tension:0.3,
                    fill:true,
                    pointRadius:4,
                    pointBackgroundColor:"#ef4444"
                }
            ]
        },
        options:{
            responsive:true,
            maintainAspectRatio:true,
            plugins:{
                legend:{display:true,position:'top',labels:{font:{size:12,weight:'bold'}}}
            },
            scales:{
                y:{beginAtZero:true,grid:{color:'rgba(0,0,0,0.05)'}}
            }
        }
    });
}

function renderizarTabla(filas){
    const tablaBody = document.getElementById('tablaDetalle');
    
    if(filas.length === 0){
        tablaBody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:20px;color:#6b7280;">No se encontraron registros con los filtros aplicados</td></tr>';
        return;
    }
    
    let html = '';
    filas.forEach(f => {
        const pctNum = parseFloat(f.pctVacio.replace('%','').replace(',','.')) || 0;
        const rowClass = pctNum > 25 ? 'highlight-row' : '';
        
        html += `
        <tr class="${rowClass}">
            <td>${f.udn}</td>
            <td>${f.gerente}</td>
            <td>${f.jefe}</td>
            <td>${f.cliente}</td>
            <td style="text-align:right;font-weight:600;">${formatearNumero(f.kmRecorridos)}</td>
            <td style="text-align:right;">${formatearNumero(f.kmServicios)}</td>
            <td style="text-align:right;">${formatearNumero(f.kmMtto)}</td>
            <td style="text-align:right;">${formatearNumero(f.kmIneficiente)}</td>
            <td style="font-weight:700;color:${pctNum > 25 ? '#dc2626' : '#059669'};">${f.pctVacio}</td>
        </tr>`;
    });
    
    tablaBody.innerHTML = html;
}

function renderizarTablaCarro(filas){
    const tablaBody = document.getElementById('tablaCarro');
    
    if(filas.length === 0){
        tablaBody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;color:#6b7280;">No se encontraron registros con los filtros aplicados</td></tr>';
        return;
    }
    
    let html = '';
    filas.forEach(f => {
        const pctNum = parseFloat(f.pctVacio.replace('%','').replace(',','.')) || 0;
        const rowClass = pctNum > 25 ? 'highlight-row' : '';
        
        html += `
        <tr class="${rowClass}">
            <td style="font-weight:600;">${f.economico}</td>
            <td>${f.gerente}</td>
            <td>${f.jefe}</td>
            <td style="text-align:right;font-weight:600;">${formatearNumero(f.kmRecorridos)}</td>
            <td style="text-align:right;">${formatearNumero(f.kmServicios)}</td>
            <td style="text-align:right;">${formatearNumero(f.kmMtto)}</td>
            <td style="text-align:right;">${formatearNumero(f.kmIneficiente)}</td>
            <td style="font-weight:700;color:${pctNum > 25 ? '#dc2626' : '#059669'};">${f.pctVacio}</td>
        </tr>`;
    });
    
    tablaBody.innerHTML = html;
}

function filtrarTabla(){
    const filtroGerente = document.getElementById('filtroGerente').value.toUpperCase();
    const filtroJefe = document.getElementById('filtroJefe').value.toUpperCase();
    const filtroCliente = document.getElementById('filtroCliente').value.toUpperCase();
    
    const filasFiltradas = todasLasFilas.filter(f => {
        const coincideGerente = !filtroGerente || f.gerente.toUpperCase().includes(filtroGerente);
        const coincideJefe = !filtroJefe || f.jefe.toUpperCase().includes(filtroJefe);
        const coincideCliente = !filtroCliente || f.cliente.toUpperCase().includes(filtroCliente);
        return coincideGerente && coincideJefe && coincideCliente;
    });
    
    renderizarTabla(filasFiltradas);
}

function filtrarTablaCarro(){
    const filtroEconomico = document.getElementById('filtroEconomico').value.toUpperCase();
    const filtroGerente = document.getElementById('filtroGerenteCarro').value.toUpperCase();
    const filtroJefe = document.getElementById('filtroJefeCarro').value.toUpperCase();
    
    const filasFiltradas = todasLasFilasCarro.filter(f => {
        const coincideEconomico = !filtroEconomico || f.economico.toUpperCase().includes(filtroEconomico);
        const coincideGerente = !filtroGerente || f.gerente.toUpperCase().includes(filtroGerente);
        const coincideJefe = !filtroJefe || f.jefe.toUpperCase().includes(filtroJefe);
        return coincideEconomico && coincideGerente && coincideJefe;
    });
    
    renderizarTablaCarro(filasFiltradas);
}

function limpiarFiltros(){
    document.getElementById('filtroGerente').value = '';
    document.getElementById('filtroJefe').value = '';
    document.getElementById('filtroCliente').value = '';
    renderizarTabla(todasLasFilas);
}

function limpiarFiltrosCarro(){
    document.getElementById('filtroEconomico').value = '';
    document.getElementById('filtroGerenteCarro').value = '';
    document.getElementById('filtroJefeCarro').value = '';
    renderizarTablaCarro(todasLasFilasCarro);
}

function exportarExcelCliente(){
    if(todasLasFilas.length === 0){
        alert('No hay datos para exportar');
        return;
    }
    
    const unidad = document.getElementById('unidadNegocio').value;
    const fecha = new Date().toLocaleDateString('es-MX');
    
    let csv = 'Unidad de Negocio,Gerente de OP,Jefe de OP,Cliente,KM Recorridos,KM de Servicios,KM Mtto/Carga/RH/Seg,KM Ineficiente,% Vac√≠o\n';
    
    todasLasFilas.forEach(f => {
        csv += `"${f.udn}","${f.gerente}","${f.jefe}","${f.cliente}",${f.kmRecorridos},${f.kmServicios},${f.kmMtto},${f.kmIneficiente},"${f.pctVacio}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `Detalle_Kilometros_Cliente_${unidad.replace(' ','_')}_${fecha}.csv`;
    link.click();
}

function exportarExcelCarro(){
    if(todasLasFilasCarro.length === 0){
        alert('No hay datos para exportar');
        return;
    }
    
    const unidad = document.getElementById('unidadNegocio').value;
    const fecha = new Date().toLocaleDateString('es-MX');
    
    let csv = 'Econ√≥mico,Gerente de OP,Jefe de OP,KM Recorridos,KM de Servicios,KM Mtto/Carga/RH/Seg,KM Ineficiente,% Vac√≠o\n';
    
    todasLasFilasCarro.forEach(f => {
        csv += `"${f.economico}","${f.gerente}","${f.jefe}",${f.kmRecorridos},${f.kmServicios},${f.kmMtto},${f.kmIneficiente},"${f.pctVacio}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `Detalle_Kilometros_Carro_${unidad.replace(' ','_')}_${fecha}.csv`;
    link.click();
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('unidadNegocio').addEventListener('change', actualizar);
    
    // Filtros tabla cliente
    document.getElementById('filtroGerente').addEventListener('input', filtrarTabla);
    document.getElementById('filtroJefe').addEventListener('input', filtrarTabla);
    document.getElementById('filtroCliente').addEventListener('input', filtrarTabla);
    document.getElementById('btnExportarCliente').addEventListener('click', exportarExcelCliente);
    document.getElementById('btnLimpiarCliente').addEventListener('click', limpiarFiltros);
    
    // Filtros tabla carro
    document.getElementById('filtroEconomico').addEventListener('input', filtrarTablaCarro);
    document.getElementById('filtroGerenteCarro').addEventListener('input', filtrarTablaCarro);
    document.getElementById('filtroJefeCarro').addEventListener('input', filtrarTablaCarro);
    document.getElementById('btnExportarCarro').addEventListener('click', exportarExcelCarro);
    document.getElementById('btnLimpiarCarro').addEventListener('click', limpiarFiltrosCarro);
    
    // Cargar datos iniciales
    actualizar();
});
</script>

</body>
</html>
