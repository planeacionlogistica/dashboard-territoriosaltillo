<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Traxion</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
    background:#f3f4f6;
    color:#1f2937;
    min-height:100vh;
}

.container-fluid{
    display:flex;
    flex-wrap:wrap;
}

.sidebar{
    width:260px;
    background:#1f2937;
    min-height:100vh;
    padding:25px 20px;
}
.sidebar h2{
    color:#84cc16;
    text-align:center;
    margin-bottom:30px;
    font-size:28px;
}
.menu-item{
    padding:14px 18px;
    border-radius:10px;
    margin-bottom:12px;
    color:#d1d5db;
    font-weight:600;
    cursor:pointer;
    transition:all 0.3s;
}
.menu-item:hover{
    background:#374151;
}
.menu-item.active{
    background:#84cc16;
    color:#1f2937;
}

.content{
    flex:1;
    padding:30px;
    min-width:0;
}

header{
    background:linear-gradient(135deg,#1f2937,#374151);
    padding:30px;
    border-radius:14px;
    margin-bottom:20px;
}
header h1{
    color:#84cc16;
    font-size:32px;
    margin-bottom:8px;
}
.subtitle{
    color:#d1d5db;
    font-size:16px;
}

.filter-bar{
    margin:0 0 20px 0;
}
.filter-bar select{
    padding:12px 16px;
    border-radius:10px;
    border:2px solid #e5e7eb;
    font-size:15px;
    font-weight:600;
    min-width:250px;
    background:#ffffff;
    cursor:pointer;
    transition:border 0.3s;
}
.filter-bar select:focus{
    outline:none;
    border-color:#84cc16;
}

.kpi-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
    gap:18px;
    margin-bottom:25px;
}

.kpi-card{
    background:#ffffff;
    border:2px solid #e5e7eb;
    border-radius:12px;
    padding:20px;
    transition:transform 0.2s, box-shadow 0.2s;
}
.kpi-card:hover{
    transform:translateY(-2px);
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
}
.kpi-card.highlight{
    border-left:5px solid #84cc16;
}
.kpi-card.warning{
    border-left:5px solid #f59e0b;
}

.kpi-label{
    font-size:11px;
    font-weight:700;
    color:#6b7280;
    text-transform:uppercase;
    letter-spacing:0.5px;
    margin-bottom:8px;
}
.kpi-value{
    font-size:28px;
    font-weight:800;
    color:#1f2937;
    margin:8px 0;
}
.kpi-value.highlight{
    color:#84cc16;
}
.kpi-subvalue{
    font-size:12px;
    color:#9ca3af;
    margin-top:6px;
    line-height:1.4;
}

.chart-row{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(400px, 1fr));
    gap:20px;
    margin-bottom:25px;
}

.chart-container{
    background:#ffffff;
    border:2px solid #e5e7eb;
    border-radius:12px;
    padding:20px;
    transition:transform 0.2s, box-shadow 0.2s;
}
.chart-container:hover{
    transform:translateY(-2px);
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
}
.chart-container h3{
    font-size:16px;
    font-weight:700;
    margin-bottom:15px;
    color:#1f2937;
    padding-bottom:10px;
    border-bottom:2px solid #84cc16;
}
canvas{
    max-height:280px;
}

@media (max-width: 1400px){
    .kpi-grid{
        grid-template-columns:repeat(3, 1fr);
    }
}

@media (max-width: 1024px){
    .sidebar{
        width:100%;
        min-height:auto;
    }
    .container-fluid{
        flex-direction:column;
    }
    .kpi-grid{
        grid-template-columns:repeat(2, 1fr);
    }
    .chart-row{
        grid-template-columns:1fr;
    }
}

@media (max-width: 640px){
    .content{
        padding:15px;
    }
    header{
        padding:20px;
    }
    header h1{
        font-size:24px;
    }
    .kpi-grid{
        grid-template-columns:1fr;
    }
    .kpi-value{
        font-size:24px;
    }
    .filter-bar select{
        width:100%;
    }
}
</style>
</head>

<body>

<div class="container-fluid">
    <aside class="sidebar">
        <h2>üöõ Traxion</h2>
        <div class="menu-item active" data-seccion="kilometros">üìä Kil√≥metros</div>
        <div class="menu-item" data-seccion="flota">üöó Flota Vehicular</div>
        <div class="menu-item" data-seccion="scoreseg">üõ°Ô∏è Eventos Score Seg</div>
    </aside>

    <main class="content">

    <!-- ==================== SECCI√ìN 1: KIL√ìMETROS ==================== -->
    <section id="seccion-kilometros" class="seccion-dashboard">

    <header>
        <h1>Dashboard de Kil√≥metros Recorridos</h1>
        <p class="subtitle" id="headerPeriodo">Cargando datos...</p>
    </header>

    <div class="filter-bar">
        <select id="unidadNegocio">
            <option value="SETTEPI SALTILLO">SETTEPI SALTILLO</option>
            <option value="LIPU SALTILLO">LIPU SALTILLO</option>
        </select>
    </div>

    <!-- KPIs -->
    <div class="kpi-grid">
        <div class="kpi-card highlight">
            <div class="kpi-label">Total KM Recorridos</div>
            <div class="kpi-value highlight" id="kpiTotal">0 km</div>
            <div class="kpi-subvalue">Acumulado del periodo</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">KM Permitidos</div>
            <div class="kpi-value" id="kpiPermitido">0 km</div>
            <div class="kpi-subvalue">L√≠mite establecido</div>
        </div>

        <div class="kpi-card highlight">
            <div class="kpi-label">Margen Disponible</div>
            <div class="kpi-value highlight" id="kpiMargen">0 km</div>
            <div class="kpi-subvalue" id="txtMargen">Calculando...</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">KM de Servicio</div>
            <div class="kpi-value" id="kpiServicio">0 km</div>
            <div class="kpi-subvalue" id="pctServicio">0% del total</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">KM Mtto / Carga / RH / Seg</div>
            <div class="kpi-value" id="kpiMtto">0 km</div>
            <div class="kpi-subvalue" id="pctMtto">0% del total</div>
        </div>

        <div class="kpi-card warning">
            <div class="kpi-label">KM Ineficiente (Vac√≠o)</div>
            <div class="kpi-value" id="kpiVacio">0 km</div>
            <div class="kpi-subvalue" id="pctVacio">0% del total</div>
        </div>
    </div>

    <!-- Gr√°ficas -->
    <div class="chart-row">
        <div class="chart-container">
            <h3>KM Recorridos vs Permitido por D√≠a</h3>
            <canvas id="chartProgreso"></canvas>
        </div>

        <div class="chart-container">
            <h3>Distribuci√≥n Total (%)</h3>
            <canvas id="chartDistribucion"></canvas>
        </div>

        <div class="chart-container">
            <h3>Comportamiento Diario</h3>
            <canvas id="chartDiario"></canvas>
        </div>
    </div>

    <!-- Tabla de Detalle -->
    <div class="chart-container">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
            <h3 style="margin:0;">Detalle por Cliente</h3>
            <button id="btnExportar" style="
                background:#84cc16;
                color:#1f2937;
                border:none;
                padding:10px 20px;
                border-radius:8px;
                font-weight:700;
                font-size:14px;
                cursor:pointer;
                transition:all 0.3s;
                box-shadow:0 2px 4px rgba(0,0,0,0.1);
            " onmouseover="this.style.background='#65a30d'" onmouseout="this.style.background='#84cc16'">
                üì• Exportar a Excel
            </button>
        </div>
        
        <!-- Filtros -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:15px;">
            <input type="text" id="filtroGerente" placeholder="üîç Filtrar Gerente" style="padding:8px;border:2px solid #e5e7eb;border-radius:6px;font-size:13px;">
            <input type="text" id="filtroJefe" placeholder="üîç Filtrar Jefe" style="padding:8px;border:2px solid #e5e7eb;border-radius:6px;font-size:13px;">
            <input type="text" id="filtroCliente" placeholder="üîç Filtrar Cliente" style="padding:8px;border:2px solid #e5e7eb;border-radius:6px;font-size:13px;">
            <button id="btnLimpiar" style="padding:8px;border:2px solid #e5e7eb;border-radius:6px;background:#fff;cursor:pointer;font-weight:600;" onclick="limpiarFiltros()">üóëÔ∏è Limpiar</button>
        </div>
        
        <div style="overflow-x:auto;">
            <table style="margin:0 auto;max-width:100%;">
                <thead>
                    <tr>
                        <th>Unidad de Negocio</th>
                        <th>Gerente de OP</th>
                        <th>Jefe de OP</th>
                        <th>Cliente</th>
                        <th>KM Recorridos</th>
                        <th>KM de Servicios</th>
                        <th>KM Mtto/Carga/RH/Seg</th>
                        <th>KM Ineficiente</th>
                        <th>% Vac√≠o</th>
                    </tr>
                </thead>
                <tbody id="tablaDetalle"></tbody>
            </table>
        </div>
    </div>

    </section>
    <!-- ==================== FIN SECCI√ìN KIL√ìMETROS ==================== -->


    <!-- ==================== SECCI√ìN 2: FLOTA VEHICULAR ==================== -->
    <section id="seccion-flota" class="seccion-dashboard" style="display:none;">

    <header>
        <h1>Dashboard de Flota Vehicular</h1>
        <p class="subtitle">Gesti√≥n y monitoreo de veh√≠culos</p>
    </header>

    <div style="text-align:center;padding:100px 20px;">
        <h2 style="color:#84cc16;font-size:48px;margin-bottom:20px;">üöó</h2>
        <h3 style="color:#6b7280;font-size:24px;margin-bottom:10px;">Secci√≥n en construcci√≥n</h3>
        <p style="color:#9ca3af;font-size:16px;">Aqu√≠ ir√° el contenido de Flota Vehicular</p>
        <p style="color:#9ca3af;font-size:14px;margin-top:20px;">
            Dime qu√© KPIs, gr√°ficas y tablas necesitas para esta secci√≥n
        </p>
    </div>

    </section>
    <!-- ==================== FIN SECCI√ìN FLOTA ==================== -->


    <!-- ==================== SECCI√ìN 3: EVENTOS SCORE SEG ==================== -->
    <section id="seccion-scoreseg" class="seccion-dashboard" style="display:none;">

    <header>
        <h1>Dashboard de Eventos Score Seg</h1>
        <p class="subtitle">Monitoreo de seguridad y comportamiento</p>
    </header>

    <!-- Filtros M√∫ltiples -->
    <div class="chart-container" style="margin-bottom:20px;">
        <h3>Filtros de B√∫squeda</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:15px;">
            <select id="filtroScoreUDN" style="padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;">
                <option value="">Todas las UDN</option>
            </select>
            <select id="filtroScoreGerente" style="padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;">
                <option value="">Todos los Gerentes</option>
            </select>
            <select id="filtroScoreJefe" style="padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;">
                <option value="">Todos los Jefes</option>
            </select>
            <select id="filtroScoreAnio" style="padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;">
                <option value="">Todos los A√±os</option>
            </select>
            <select id="filtroScoreMes" style="padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;">
                <option value="">Todos los Meses</option>
            </select>
            <select id="filtroScoreSem" style="padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;">
                <option value="">Todas las Semanas</option>
            </select>
            <select id="filtroScoreDia" style="padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;">
                <option value="">Todos los D√≠as</option>
            </select>
            <select id="filtroScoreCliente" style="padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;">
                <option value="">Todos los Clientes</option>
            </select>
            <input type="text" id="filtroScoreOperador" placeholder="üîç Buscar Operador" style="padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:13px;">
            <button onclick="limpiarFiltrosScore()" style="padding:10px;border:2px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer;font-weight:600;">
                üóëÔ∏è Limpiar Filtros
            </button>
        </div>
        <div style="margin-top:15px;padding:10px;background:#f3f4f6;border-radius:8px;">
            <span style="font-size:14px;color:#6b7280;">Registros mostrados: <strong id="contadorRegistros">0</strong></span>
        </div>
    </div>

    <!-- Tabla de Score Seg -->
    <div class="chart-container">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
            <h3 style="margin:0;">Detalle de Eventos por Operador</h3>
            <button onclick="exportarScoreExcel()" style="
                background:#84cc16;
                color:#1f2937;
                border:none;
                padding:10px 20px;
                border-radius:8px;
                font-weight:700;
                font-size:14px;
                cursor:pointer;
                transition:all 0.3s;
                box-shadow:0 2px 4px rgba(0,0,0,0.1);
            " onmouseover="this.style.background='#65a30d'" onmouseout="this.style.background='#84cc16'">
                üì• Exportar a Excel
            </button>
        </div>
        
        <div style="overflow-x:auto;">
            <table id="tablaScoreSeg" style="font-size:12px;">
                <thead>
                    <tr>
                        <th>UDN</th>
                        <th>Operador</th>
                        <th>Cliente</th>
                        <th colspan="5" style="background:#dc2626;color:white;">EVENTOS CR√çTICOS</th>
                        <th colspan="5" style="background:#f59e0b;color:white;">EVENTOS MODERADOS</th>
                        <th colspan="4" style="background:#eab308;color:white;">EVENTOS LEVES</th>
                        <th style="background:#1f2937;color:#84cc16;">SCORE</th>
                    </tr>
                    <tr style="background:#f9fafb;">
                        <th colspan="9"></th>
                        <th style="font-size:10px;">Acel</th>
                        <th style="font-size:10px;">Freno</th>
                        <th style="font-size:10px;">Giro D</th>
                        <th style="font-size:10px;">Giro I</th>
                        <th style="font-size:10px;">Veloc</th>
                        <th style="font-size:10px;">Acel</th>
                        <th style="font-size:10px;">Freno</th>
                        <th style="font-size:10px;">Giro D</th>
                        <th style="font-size:10px;">Giro I</th>
                        <th style="font-size:10px;">Veloc</th>
                        <th style="font-size:10px;">Freno</th>
                        <th style="font-size:10px;">Giro D</th>
                        <th style="font-size:10px;">Giro I</th>
                        <th style="font-size:10px;">Veloc</th>
                        <th style="font-size:10px;">Final</th>
                    </tr>
                </thead>
                <tbody id="tablaScoreBody"></tbody>
            </table>
        </div>
    </div>

    </section>
    <!-- ==================== FIN SECCI√ìN SCORE SEG ==================== -->

    </main>
</div>

<script>
const SHEET_ID = "1l3QYg7N050BScrtNhKkHQ-hHNDgaK9Prw95Dzb2-DRE";
const SHEET_NAME = "Kilometros";

// ====== SISTEMA DE NAVEGACI√ìN ENTRE SECCIONES ======
function cambiarSeccion(nombreSeccion){
    // Ocultar todas las secciones
    document.querySelectorAll('.seccion-dashboard').forEach(s => s.style.display = 'none');
    
    // Mostrar la secci√≥n seleccionada
    document.getElementById(`seccion-${nombreSeccion}`).style.display = 'block';
    
    // Actualizar men√∫ activo
    document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-seccion="${nombreSeccion}"]`).classList.add('active');
    
    // Cargar datos espec√≠ficos de la secci√≥n
    if(nombreSeccion === 'kilometros'){
        actualizar();
    } else if(nombreSeccion === 'flota'){
        // Aqu√≠ cargar√°s datos de flota cuando lo desarrollemos
        console.log('Cargando secci√≥n Flota Vehicular...');
    } else if(nombreSeccion === 'scoreseg'){
        cargarScoreSeg();
    }
}

// Event listeners para el men√∫
document.querySelectorAll('.menu-item').forEach(item => {
    item.addEventListener('click', function(){
        const seccion = this.getAttribute('data-seccion');
        cambiarSeccion(seccion);
    });
});

// ====== FUNCIONES DE KIL√ìMETROS (FASE 1) ======

function num(v){
    if(!v) return 0;
    // Eliminar $, comas, espacios y convertir a n√∫mero
    let str = v.toString().replace(/[$,\s]/g,"").trim();
    return Number(str) || 0;
}

function formatearNumero(n){
    // Formato con comas para miles y un decimal
    return n.toLocaleString('en-US', {minimumFractionDigits:1, maximumFractionDigits:1});
}

async function cargarDatos(){
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&sheet=${SHEET_NAME}`;
    const res = await fetch(url);
    const csv = await res.text();
    return new Promise(r=>{
        Papa.parse(csv,{header:false,skipEmptyLines:true,complete:x=>r(x.data)});
    });
}

let chartProgreso, chartDistribucion, chartDiario;
let todasLasFilas = []; // Guardar todas las filas para filtrar

async function actualizar(){
    const unidad = unidadNegocio.value.trim();
    const rows = await cargarDatos();

    const hoy = new Date();
    const diaActual = hoy.getDate() - 1; // D√≠a 19, vamos desfasados 1 d√≠a

    console.log('üîÑ INICIANDO ACTUALIZACI√ìN');
    console.log('Unidad seleccionada:', unidad);
    console.log('Filas cargadas del Excel:', rows.length);

    // ===== KPIs desde la PRIMERA TABLA (A-J) =====
    // SUMAR todas las filas que corresponden a la unidad
    let total=0, servicio=0, mtto=0, vacio=0, permitidoTotal=0;
    
    // KM Permitido Total de fila 7
    if(rows.length > 6){
        if(unidad === "SETTEPI SALTILLO"){
            permitidoTotal = num(rows[6][28]); // AC7
        } else {
            permitidoTotal = num(rows[6][29]); // AD7
        }
    }

    // SUMAR todos los KPIs en columnas A-J (primera tabla)
    for(let i = 1; i < rows.length; i++){
        const r = rows[i];
        const udnRow = (r[0]||"").toString().trim().toUpperCase();
        
        // Si la columna A contiene la UDN, sumar esa fila
        if(udnRow.includes("SETTEPI") && unidad === "SETTEPI SALTILLO"){
            total += num(r[4]);      // Columna E - KM Total
            servicio += num(r[5]);   // Columna F - KM Servicio
            mtto += num(r[6]);       // Columna G - KM Mtto
            vacio += num(r[7]);      // Columna H - KM Vac√≠o
        }
        else if(udnRow.includes("LIPU") && unidad === "LIPU SALTILLO"){
            total += num(r[4]);      // Columna E - KM Total
            servicio += num(r[5]);   // Columna F - KM Servicio
            mtto += num(r[6]);       // Columna G - KM Mtto
            vacio += num(r[7]);      // Columna H - KM Vac√≠o
        }
    }

    // ===== GR√ÅFICAS desde las TABLAS DIARIAS (L-R y T-Z) =====
    let datosDiarios = [];

    // Empezar desde fila 2 (√≠ndice 1) para leer TODOS los d√≠as
    for(let idx = 1; idx < rows.length; idx++){
        const r = rows[idx];
        
        let dia=0, kmTotal=0, kmServ=0, kmMtto=0, kmVac=0, kmPermDiario=0;
        let encontrado = false;
        
        if(unidad === "SETTEPI SALTILLO"){
            // Tabla SETTEPI: columnas L a R (√≠ndices 11-17)
            const udnSettepi = (r[11]||"").toString().trim().toUpperCase();
            
            if(udnSettepi === "SETTEPI" || udnSettepi.includes("SETTEPI")){
                dia = num(r[12]);           // M - D√≠a
                kmTotal = num(r[13]);       // N - KM Recorridos
                kmServ  = num(r[14]);       // O - KM Servicios
                kmMtto  = num(r[15]);       // P - KM Mtto
                kmVac   = num(r[16]);       // Q - KM Ineficiente
                kmPermDiario = num(r[17]);  // R - KM Permitido
                encontrado = true;
            }
        } else {
            // Tabla LIPU: columnas T a Z (√≠ndices 19-25)
            const udnLipu = (r[19]||"").toString().trim().toUpperCase();
            
            if(udnLipu === "LIPU" || udnLipu.includes("LIPU")){
                dia = num(r[20]);           // U - D√≠a
                kmTotal = num(r[21]);       // V - KM Recorridos
                kmServ  = num(r[22]);       // W - KM Servicios
                kmMtto  = num(r[23]);       // X - KM Mtto
                kmVac   = num(r[24]);       // Y - KM Ineficiente
                kmPermDiario = num(r[25]);  // Z - KM Permitido
                encontrado = true;
            }
        }
        
        // Solo agregar si encontr√≥ datos v√°lidos y el d√≠a es v√°lido
        if(encontrado && dia >= 1 && dia <= diaActual){
            datosDiarios.push({dia, kmTotal, kmServ, kmMtto, kmVac, kmPermDiario});
            
            // Debug para el primer d√≠a
            if(datosDiarios.length === 1){
                console.log('üîç Primer d√≠a le√≠do:');
                console.log('  Fila Excel:', idx + 1);
                console.log('  D√≠a:', dia);
                console.log('  KM Total:', kmTotal, '(columna', unidad === "SETTEPI SALTILLO" ? 'N/13' : 'V/21', ')');
                console.log('  KM Permitido:', kmPermDiario, '(columna', unidad === "SETTEPI SALTILLO" ? 'R/17' : 'Z/25', ')');
                console.log('  Valor raw columna Z:', r[25]);
            }
        }
    }

    console.log(`Datos diarios encontrados: ${datosDiarios.length} d√≠as`);
    console.log('Primeros 3 d√≠as completos:', datosDiarios.slice(0,3));

    // ====== ACTUALIZAR KPIs ======
    kpiTotal.innerText = formatearNumero(total)+" km";
    kpiServicio.innerText = formatearNumero(servicio)+" km";
    kpiMtto.innerText = formatearNumero(mtto)+" km";
    kpiVacio.innerText = formatearNumero(vacio)+" km";
    kpiPermitido.innerText = formatearNumero(permitidoTotal)+" km";

    const pctServ = total > 0 ? ((servicio/total)*100).toFixed(1) : 0;
    const pctMt = total > 0 ? ((mtto/total)*100).toFixed(1) : 0;
    const pctVac = total > 0 ? ((vacio/total)*100).toFixed(1) : 0;

    pctServicio.innerText = pctServ + "% del total";
    pctMtto.innerText = pctMt + "% del total";
    pctVacio.innerText = pctVac + "% del total";

    const margen = permitidoTotal - total;
    kpiMargen.innerText = formatearNumero(margen)+" km";

    const pctMargen = permitidoTotal > 0 ? ((margen/permitidoTotal)*100).toFixed(1) : 0;
    const importe = (margen*6).toLocaleString("es-MX",{style:"currency",currency:"MXN",minimumFractionDigits:1,maximumFractionDigits:1});
    txtMargen.innerHTML = `${pctMargen}% de los KM permitidos<br>Equivale a: ${importe}`;

    headerPeriodo.innerText = `Periodo al d√≠a ${diaActual} - ${unidad}`;

    // ====== CONSTRUIR TABLA PRIMERO ======
    console.log('===== CONSTRUYENDO TABLA =====');
    console.log('Unidad seleccionada:', unidad);
    console.log('Total de filas en Excel:', rows.length);
    
    const tablaBody = document.getElementById('tablaDetalle');
    if(!tablaBody){
        console.error('‚ùå No se encontr√≥ el elemento tablaDetalle');
    } else {
        console.log('‚úì Elemento tablaDetalle encontrado');
        
        tablaBody.innerHTML = '';
        
        let filasFiltradas = [];
        let filasRevisadas = 0;
        
        // Leer todas las filas de la primera tabla (A-I)
        for(let i = 1; i < rows.length; i++){
            const r = rows[i];
            if(!r || r.length < 9) continue;
            
            const udnRow = (r[0]||"").toString().trim();
            filasRevisadas++;
            
            // Debug primeras 3 filas
            if(i <= 3){
                console.log(`Fila ${i}: UDN="${udnRow}", Gerente="${r[1]}", Cliente="${r[3]}"`);
            }
            
            const udnUpper = udnRow.toUpperCase();
            let coincide = false;
            
            if(unidad === "SETTEPI SALTILLO"){
                coincide = udnUpper.includes("SETTEPI");
            } else if(unidad === "LIPU SALTILLO"){
                coincide = udnUpper.includes("LIPU");
            }
            
            if(coincide){
                filasFiltradas.push({
                    udn: udnRow,
                    gerente: r[1]||"-",
                    jefe: r[2]||"-",
                    cliente: r[3]||"-",
                    kmRecorridos: num(r[4]),
                    kmServicios: num(r[5]),
                    kmMtto: num(r[6]),
                    kmIneficiente: num(r[7]),
                    pctVacio: (r[8]||"0%").toString()
                });
            }
        }
        
        console.log(`‚úì Filas revisadas: ${filasRevisadas}`);
        console.log(`‚úì Filas que coinciden con ${unidad}: ${filasFiltradas.length}`);
        
        if(filasFiltradas.length > 0){
            console.log('Primera fila filtrada:', filasFiltradas[0]);
            
            // Ordenar por % Vac√≠o descendente
            filasFiltradas.sort((a,b)=>{
                const pctA = parseFloat(a.pctVacio.replace('%','').replace(',','.')) || 0;
                const pctB = parseFloat(b.pctVacio.replace('%','').replace(',','.')) || 0;
                return pctB - pctA;
            });
            
            // Renderizar tabla
            let html = '';
            filasFiltradas.forEach((f)=>{
                const pctNum = parseFloat(f.pctVacio.replace('%','').replace(',','.')) || 0;
                const rowClass = pctNum > 25 ? 'highlight-row' : '';
                
                html += `
                <tr class="${rowClass}">
                    <td>${f.udn}</td>
                    <td>${f.gerente}</td>
                    <td>${f.jefe}</td>
                    <td>${f.cliente}</td>
                    <td style="text-align:right;font-weight:600;">${f.kmRecorridos.toLocaleString()}</td>
                    <td style="text-align:right;">${f.kmServicios.toLocaleString()}</td>
                    <td style="text-align:right;">${f.kmMtto.toLocaleString()}</td>
                    <td style="text-align:right;">${f.kmIneficiente.toLocaleString()}</td>
                    <td style="font-weight:700;color:${pctNum > 25 ? '#dc2626' : '#059669'};">${f.pctVacio}</td>
                </tr>`;
            });
            
            tablaBody.innerHTML = html;
            console.log('‚úì Tabla renderizada con', filasFiltradas.length, 'filas');
            
            // Guardar filas para filtrado
            todasLasFilas = filasFiltradas;
        } else {
            tablaBody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:20px;color:#6b7280;">No se encontraron registros para esta UDN</td></tr>';
            console.warn('‚ö†Ô∏è No se encontraron filas para la UDN seleccionada');
            todasLasFilas = [];
        }
    }

    // ====== GR√ÅFICA 1: KM por D√≠a - Recorrido vs Permitido (L√çNEAS) ======
    datosDiarios.sort((a,b)=>a.dia-b.dia);

    let labels=[];
    let realDiario=[], perDiario=[];

    datosDiarios.forEach(d=>{
        labels.push("D√≠a "+d.dia);
        realDiario.push(d.kmTotal);          // KM del d√≠a
        perDiario.push(d.kmPermDiario);      // KM permitido del d√≠a
    });

    console.log('===== DEBUG GR√ÅFICA 1 =====');
    console.log('Unidad:', unidad);
    console.log('Total d√≠as encontrados:', datosDiarios.length);
    console.log('Labels:', labels);
    console.log('KM Real por d√≠a:', realDiario);
    console.log('KM Permitido por d√≠a:', perDiario);
    console.log('Primer dato completo:', datosDiarios[0]);

    if(chartProgreso) chartProgreso.destroy();
    
    if(labels.length > 0){
        chartProgreso = new Chart(document.getElementById("chartProgreso"),{
            type:"line",
            data:{
                labels,
                datasets:[
                    {
                        label:"KM Recorridos",
                        data:realDiario,
                        borderColor:"#84cc16",
                        backgroundColor:"rgba(132,204,22,0.2)",
                        borderWidth:3,
                        tension:0.3,
                        fill:true,
                        pointRadius:6,
                        pointBackgroundColor:"#84cc16",
                        pointBorderColor:"#fff",
                        pointBorderWidth:2
                    },
                    {
                        label:"KM Permitido",
                        data:perDiario,
                        borderColor:"#1f2937",
                        backgroundColor:"rgba(31,41,55,0.1)",
                        borderWidth:3,
                        tension:0.3,
                        fill:false,
                        pointRadius:6,
                        pointBackgroundColor:"#1f2937",
                        pointBorderColor:"#fff",
                        pointBorderWidth:2,
                        borderDash:[8,4]
                    }
                ]
            },
            options:{
                responsive:true,
                maintainAspectRatio:true,
                plugins:{
                    legend:{
                        display:true,
                        position:'top',
                        labels:{font:{size:12,weight:'bold'}}
                    }
                },
                scales:{
                    y:{
                        beginAtZero:true,
                        grid:{color:'rgba(0,0,0,0.05)'}
                    },
                    x:{
                        grid:{display:false}
                    }
                }
            }
        });
    } else {
        console.error('‚ùå No hay datos para graficar - labels est√° vac√≠o');
    }

    // ====== GR√ÅFICA 2: Distribuci√≥n con PORCENTAJES (de la primera tabla - totales) ======
    const pctServTotal = total > 0 ? ((servicio/total)*100).toFixed(1) : 0;
    const pctMttoTotal = total > 0 ? ((mtto/total)*100).toFixed(1) : 0;
    const pctVacTotal = total > 0 ? ((vacio/total)*100).toFixed(1) : 0;

    if(chartDistribucion) chartDistribucion.destroy();
    chartDistribucion = new Chart(document.getElementById("chartDistribucion"),{
        type:"doughnut",
        data:{
            labels:[
                `Servicio (${pctServTotal}%)`,
                `Mtto (${pctMttoTotal}%)`,
                `Vac√≠o (${pctVacTotal}%)`
            ],
            datasets:[{
                data:[servicio, mtto, vacio],
                backgroundColor:["#84cc16","#f59e0b","#ef4444"],
                borderWidth:3,
                borderColor:"#ffffff",
                hoverOffset:10
            }]
        },
        options:{
            responsive:true,
            maintainAspectRatio:true,
            plugins:{
                legend:{
                    display:true,
                    position:'bottom',
                    labels:{font:{size:12,weight:'bold'},padding:15}
                },
                tooltip:{
                    callbacks:{
                        label: function(context){
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            return label + ': ' + value.toLocaleString() + ' km';
                        }
                    }
                }
            },
            cutout:'60%'
        }
    });

    // ====== GR√ÅFICA 3: Comportamiento Diario ======
    let servDiario=[], mttoDiario=[], vacioDiario=[];
    datosDiarios.forEach(d=>{
        servDiario.push(d.kmServ);
        mttoDiario.push(d.kmMtto);
        vacioDiario.push(d.kmVac);
    });

    if(chartDiario) chartDiario.destroy();
    chartDiario = new Chart(document.getElementById("chartDiario"),{
        type:"line",
        data:{
            labels,
            datasets:[
                {
                    label:"Servicio",
                    data:servDiario,
                    borderColor:"#84cc16",
                    backgroundColor:"rgba(132,204,22,0.15)",
                    borderWidth:2.5,
                    tension:0.3,
                    fill:true,
                    pointRadius:4,
                    pointBackgroundColor:"#84cc16"
                },
                {
                    label:"Mtto",
                    data:mttoDiario,
                    borderColor:"#6b7280",
                    backgroundColor:"rgba(107,114,128,0.15)",
                    borderWidth:2.5,
                    tension:0.3,
                    fill:true,
                    pointRadius:4,
                    pointBackgroundColor:"#6b7280"
                },
                {
                    label:"Vac√≠o",
                    data:vacioDiario,
                    borderColor:"#ef4444",
                    backgroundColor:"rgba(239,68,68,0.15)",
                    borderWidth:2.5,
                    tension:0.3,
                    fill:true,
                    pointRadius:4,
                    pointBackgroundColor:"#ef4444"
                }
            ]
        },
        options:{
            responsive:true,
            maintainAspectRatio:true,
            plugins:{
                legend:{display:true,position:'top',labels:{font:{size:12,weight:'bold'}}}
            },
            scales:{
                y:{beginAtZero:true,grid:{color:'rgba(0,0,0,0.05)'}}
            }
        }
    });
}

// ====== FUNCIONES DE FILTRADO ======
function filtrarTabla(){
    const filtroGerente = document.getElementById('filtroGerente').value.toUpperCase();
    const filtroJefe = document.getElementById('filtroJefe').value.toUpperCase();
    const filtroCliente = document.getElementById('filtroCliente').value.toUpperCase();
    
    const filasFiltradas = todasLasFilas.filter(f => {
        const coincideGerente = !filtroGerente || f.gerente.toUpperCase().includes(filtroGerente);
        const coincideJefe = !filtroJefe || f.jefe.toUpperCase().includes(filtroJefe);
        const coincideCliente = !filtroCliente || f.cliente.toUpperCase().includes(filtroCliente);
        return coincideGerente && coincideJefe && coincideCliente;
    });
    
    renderizarTabla(filasFiltradas);
}

function renderizarTabla(filas){
    const tablaBody = document.getElementById('tablaDetalle');
    
    if(filas.length === 0){
        tablaBody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:20px;color:#6b7280;">No se encontraron registros con los filtros aplicados</td></tr>';
        return;
    }
    
    let html = '';
    filas.forEach(f => {
        const pctNum = parseFloat(f.pctVacio.replace('%','').replace(',','.')) || 0;
        const rowClass = pctNum > 25 ? 'highlight-row' : '';
        
        html += `
        <tr class="${rowClass}">
            <td title="${f.udn}">${f.udn}</td>
            <td title="${f.gerente}">${f.gerente}</td>
            <td title="${f.jefe}">${f.jefe}</td>
            <td title="${f.cliente}">${f.cliente}</td>
            <td style="text-align:right;font-weight:600;">${formatearNumero(f.kmRecorridos)}</td>
            <td style="text-align:right;">${formatearNumero(f.kmServicios)}</td>
            <td style="text-align:right;">${formatearNumero(f.kmMtto)}</td>
            <td style="text-align:right;">${formatearNumero(f.kmIneficiente)}</td>
            <td style="font-weight:700;color:${pctNum > 25 ? '#dc2626' : '#059669'};">${f.pctVacio}</td>
        </tr>`;
    });
    
    tablaBody.innerHTML = html;
}

function limpiarFiltros(){
    document.getElementById('filtroGerente').value = '';
    document.getElementById('filtroJefe').value = '';
    document.getElementById('filtroCliente').value = '';
    renderizarTabla(todasLasFilas);
}

// ====== EXPORTAR A EXCEL ======
function exportarExcel(){
    if(todasLasFilas.length === 0){
        alert('No hay datos para exportar');
        return;
    }
    
    const unidad = document.getElementById('unidadNegocio').value;
    const fecha = new Date().toLocaleDateString('es-MX');
    
    // Crear CSV
    let csv = 'Unidad de Negocio,Gerente de OP,Jefe de OP,Cliente,KM Recorridos,KM de Servicios,KM Mtto/Carga/RH/Seg,KM Ineficiente,% Vac√≠o\n';
    
    todasLasFilas.forEach(f => {
        csv += `"${f.udn}","${f.gerente}","${f.jefe}","${f.cliente}",${f.kmRecorridos},${f.kmServicios},${f.kmMtto},${f.kmIneficiente},"${f.pctVacio}"\n`;
    });
    
    // Descargar
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `Detalle_Kilometros_${unidad.replace(' ','_')}_${fecha}.csv`;
    link.click();
}

unidadNegocio.addEventListener("change",actualizar);

// Event listeners para filtros
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('filtroGerente')?.addEventListener('input', filtrarTabla);
    document.getElementById('filtroJefe')?.addEventListener('input', filtrarTabla);
    document.getElementById('filtroCliente')?.addEventListener('input', filtrarTabla);
    document.getElementById('btnExportar')?.addEventListener('click', exportarExcel);
});

actualizar();

// ====== FUNCIONES DE SCORE SEG (FASE 3) ======
const SHEET_SCORESEG = "Detalle ScoreSeg";
let datosScoreSeg = [];
let datosScoreFiltrados = [];

async function cargarScoreSeg(){
    console.log('üîÑ Cargando Score Seg...');
    
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&sheet=${encodeURIComponent(SHEET_SCORESEG)}`;
    const res = await fetch(url);
    const csv = await res.text();
    
    Papa.parse(csv, {
        header: false,
        skipEmptyLines: true,
        complete: function(results){
            const rows = results.data;
            datosScoreSeg = [];
            
            console.log('Primera fila (encabezados):', rows[0]);
            console.log('Segunda fila (primer dato):', rows[1]);
            
            // Leer desde fila 2 (√≠ndice 1) para saltar encabezados
            for(let i = 1; i < rows.length; i++){
                const r = rows[i];
                if(!r || r.length < 24) continue;
                
                datosScoreSeg.push({
                    udn: r[0]||"",              // Columna A - UDN
                    gerente: r[1]||"",          // Columna B - Gerente (solo filtro)
                    jefe: r[2]||"",             // Columna C - Jefe (solo filtro)
                    anio: r[3]||"",             // Columna D - A√±o (solo filtro)
                    mes: r[4]||"",              // Columna E - Mes (solo filtro)
                    sem: r[5]||"",              // Columna F - Sem (solo filtro)
                    dia: r[6]||"",              // Columna G - D√≠a (solo filtro)
                    operador: r[7]||"",         // Columna H - NOMBRE (mostrar)
                    cliente: r[8]||"",          // Columna I - CLIENTE (solo filtro)
                    // Eventos Cr√≠ticos (J-N, √≠ndices 9-13)
                    critAcel: num(r[9]),        // Columna J - ACELERACION
                    critFreno: num(r[10]),      // Columna K - FRENO
                    critGiroD: num(r[11]),      // Columna L - GIRO DER
                    critGiroI: num(r[12]),      // Columna M - GIRO IZQ
                    critVeloc: num(r[13]),      // Columna N - VELOCIDAD
                    // Eventos Moderados (O-S, √≠ndices 14-18)
                    modAcel: num(r[14]),        // Columna O - ACELERACION
                    modFreno: num(r[15]),       // Columna P - FRENO
                    modGiroD: num(r[16]),       // Columna Q - GIRO DER
                    modGiroI: num(r[17]),       // Columna R - GIRO IZQ
                    modVeloc: num(r[18]),       // Columna S - VELOCIDAD
                    // Eventos Leves (T-W, √≠ndices 19-22)
                    levFreno: num(r[19]),       // Columna T - FRENO
                    levGiroD: num(r[20]),       // Columna U - GIRO DER
                    levGiroI: num(r[21]),       // Columna V - GIRO IZQ
                    levVeloc: num(r[22]),       // Columna W - VELOCIDAD
                    // Score (X, √≠ndice 23)
                    score: num(r[23])           // Columna X - SCORE DE SEG
                });
            }
            
            console.log(`‚úì Score Seg cargado: ${datosScoreSeg.length} registros`);
            console.log('Primer registro completo:', datosScoreSeg[0]);
            poblarFiltrosScore();
            datosScoreFiltrados = [...datosScoreSeg];
            renderizarTablaScore();
        }
    });
}

function poblarFiltrosScore(){
    const udns = [...new Set(datosScoreSeg.map(d => d.udn))].sort();
    const gerentes = [...new Set(datosScoreSeg.map(d => d.gerente))].sort();
    const jefes = [...new Set(datosScoreSeg.map(d => d.jefe))].sort();
    const anios = [...new Set(datosScoreSeg.map(d => d.anio))].sort();
    const meses = [...new Set(datosScoreSeg.map(d => d.mes))].sort();
    const sems = [...new Set(datosScoreSeg.map(d => d.sem))].sort();
    const dias = [...new Set(datosScoreSeg.map(d => d.dia))].sort();
    const clientes = [...new Set(datosScoreSeg.map(d => d.cliente))].sort();
    
    document.getElementById('filtroScoreUDN').innerHTML = '<option value="">Todas las UDN</option>' + 
        udns.map(u => `<option value="${u}">${u}</option>`).join('');
    
    document.getElementById('filtroScoreGerente').innerHTML = '<option value="">Todos los Gerentes</option>' + 
        gerentes.map(g => `<option value="${g}">${g}</option>`).join('');
    
    document.getElementById('filtroScoreJefe').innerHTML = '<option value="">Todos los Jefes</option>' + 
        jefes.map(j => `<option value="${j}">${j}</option>`).join('');
    
    document.getElementById('filtroScoreAnio').innerHTML = '<option value="">Todos los A√±os</option>' + 
        anios.map(a => `<option value="${a}">${a}</option>`).join('');
    
    document.getElementById('filtroScoreMes').innerHTML = '<option value="">Todos los Meses</option>' + 
        meses.map(m => `<option value="${m}">${m}</option>`).join('');
    
    document.getElementById('filtroScoreSem').innerHTML = '<option value="">Todas las Semanas</option>' + 
        sems.map(s => `<option value="${s}">${s}</option>`).join('');
    
    document.getElementById('filtroScoreDia').innerHTML = '<option value="">Todos los D√≠as</option>' + 
        dias.map(d => `<option value="${d}">${d}</option>`).join('');
    
    document.getElementById('filtroScoreCliente').innerHTML = '<option value="">Todos los Clientes</option>' + 
        clientes.map(c => `<option value="${c}">${c}</option>`).join('');
    
    // Event listeners
    document.getElementById('filtroScoreUDN').addEventListener('change', filtrarScoreSeg);
    document.getElementById('filtroScoreGerente').addEventListener('change', filtrarScoreSeg);
    document.getElementById('filtroScoreJefe').addEventListener('change', filtrarScoreSeg);
    document.getElementById('filtroScoreAnio').addEventListener('change', filtrarScoreSeg);
    document.getElementById('filtroScoreMes').addEventListener('change', filtrarScoreSeg);
    document.getElementById('filtroScoreSem').addEventListener('change', filtrarScoreSeg);
    document.getElementById('filtroScoreDia').addEventListener('change', filtrarScoreSeg);
    document.getElementById('filtroScoreCliente').addEventListener('change', filtrarScoreSeg);
    document.getElementById('filtroScoreOperador').addEventListener('input', filtrarScoreSeg);
}

function filtrarScoreSeg(){
    const fUdn = document.getElementById('filtroScoreUDN').value;
    const fGerente = document.getElementById('filtroScoreGerente').value;
    const fJefe = document.getElementById('filtroScoreJefe').value;
    const fAnio = document.getElementById('filtroScoreAnio').value;
    const fMes = document.getElementById('filtroScoreMes').value;
    const fSem = document.getElementById('filtroScoreSem').value;
    const fDia = document.getElementById('filtroScoreDia').value;
    const fCliente = document.getElementById('filtroScoreCliente').value;
    const fOperador = document.getElementById('filtroScoreOperador').value.toUpperCase();
    
    datosScoreFiltrados = datosScoreSeg.filter(d => {
        return (!fUdn || d.udn === fUdn) &&
               (!fGerente || d.gerente === fGerente) &&
               (!fJefe || d.jefe === fJefe) &&
               (!fAnio || d.anio === fAnio) &&
               (!fMes || d.mes === fMes) &&
               (!fSem || d.sem === fSem) &&
               (!fDia || d.dia === fDia) &&
               (!fCliente || d.cliente === fCliente) &&
               (!fOperador || d.operador.toUpperCase().includes(fOperador));
    });
    
    renderizarTablaScore();
}

function renderizarTablaScore(){
    const tbody = document.getElementById('tablaScoreBody');
    
    if(datosScoreFiltrados.length === 0){
        tbody.innerHTML = '<tr><td colspan="24" style="text-align:center;padding:30px;color:#6b7280;">No se encontraron registros</td></tr>';
        document.getElementById('contadorRegistros').innerText = '0';
        return;
    }
    
    let html = '';
    datosScoreFiltrados.forEach(d => {
        // Funci√≥n para colorear celdas de eventos
        const colorEvento = (val) => {
            if(val === 0) return 'background:#ffffff;';
            if(val >= 1) return 'background:#fef3c7;font-weight:600;';
            return '';
        };
        
        // Color del score
        let scoreColor = '#dc2626'; // Rojo por defecto
        if(d.score >= 90) scoreColor = '#22c55e'; // Verde
        else if(d.score >= 80) scoreColor = '#eab308'; // Amarillo
        else if(d.score >= 70) scoreColor = '#f59e0b'; // Naranja
        
      html += `
            <tr>
                <td>${d.udn}</td>
                <td style="font-weight:600;">${d.operador}</td>
                <td style="${colorEvento(d.critAcel)}">${d.critAcel}</td>
                <td style="${colorEvento(d.critFreno)}">${d.critFreno}</td>
                <td style="${colorEvento(d.critGiroD)}">${d.critGiroD}</td>
                <td style="${colorEvento(d.critGiroI)}">${d.critGiroI}</td>
                <td style="${colorEvento(d.critVeloc)}">${d.critVeloc}</td>
                <td style="${colorEvento(d.modAcel)}">${d.modAcel}</td>
                <td style="${colorEvento(d.modFreno)}">${d.modFreno}</td>
                <td style="${colorEvento(d.modGiroD)}">${d.modGiroD}</td>
                <td style="${colorEvento(d.modGiroI)}">${d.modGiroI}</td>
                <td style="${colorEvento(d.modVeloc)}">${d.modVeloc}</td>
                <td style="${colorEvento(d.levFreno)}">${d.levFreno}</td>
                <td style="${colorEvento(d.levGiroD)}">${d.levGiroD}</td>
                <td style="${colorEvento(d.levGiroI)}">${d.levGiroI}</td>
                <td style="${colorEvento(d.levVeloc)}">${d.levVeloc}</td>
                <td style="background:${scoreColor};color:white;font-weight:800;font-size:14px;">${d.score.toFixed(1)}</td>
            </tr>`;
    });
    
    tbody.innerHTML = html;
    document.getElementById('contadorRegistros').innerText = datosScoreFiltrados.length.toLocaleString();
}

function limpiarFiltrosScore(){
    document.getElementById('filtroScoreUDN').value = '';
    document.getElementById('filtroScoreGerente').value = '';
    document.getElementById('filtroScoreJefe').value = '';
    document.getElementById('filtroScoreAnio').value = '';
    document.getElementById('filtroScoreMes').value = '';
    document.getElementById('filtroScoreSem').value = '';
    document.getElementById('filtroScoreDia').value = '';
    document.getElementById('filtroScoreCliente').value = '';
    document.getElementById('filtroScoreOperador').value = '';
    datosScoreFiltrados = [...datosScoreSeg];
    renderizarTablaScore();
}

function exportarScoreExcel(){
    if(datosScoreFiltrados.length === 0){
        alert('No hay datos para exportar');
        return;
    }
    let csv = 'UDN,Operador,';
    csv += 'Acel Crit,Freno Crit,Giro D Crit,Giro I Crit,Veloc Crit,';
    csv += 'Acel Mod,Freno Mod,Giro D Mod,Giro I Mod,Veloc Mod,';
    csv += 'Freno Leve,Giro D Leve,Giro I Leve,Veloc Leve,Score\n';
    
    datosScoreFiltrados.forEach(d => {
        csv += `"${d.udn}","${d.operador}",`;
        csv += `${d.critAcel},${d.critFreno},${d.critGiroD},${d.critGiroI},${d.critVeloc},`;
        csv += `${d.modAcel},${d.modFreno},${d.modGiroD},${d.modGiroI},${d.modVeloc},`;
        csv += `${d.levFreno},${d.levGiroD},${d.levGiroI},${d.levVeloc},${d.score}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `Score_Seg_${fecha}.csv`;
    link.click();
}

</script>

</body>
</html>

