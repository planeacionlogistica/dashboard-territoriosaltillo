<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Traxion</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
    background:#f3f4f6;
    color:#1f2937;
    display:flex;
}

/* ====== SIDEBAR ====== */
.sidebar{
    width:260px;
    background:#1f2937;
    min-height:100vh;
    padding:25px 20px;
}
.sidebar h2{
    color:#84cc16;
    text-align:center;
    margin-bottom:30px;
}
.menu-item{
    padding:14px 18px;
    border-radius:10px;
    margin-bottom:12px;
    color:#d1d5db;
    font-weight:600;
    cursor:pointer;
}
.menu-item.active{
    background:#84cc16;
    color:#1f2937;
}

/* ====== CONTENT ====== */
.content{
    flex:1;
    padding:30px;
}
.container{
    max-width:1600px;
    margin:auto;
}

/* ====== HEADER ====== */
header{
    background:linear-gradient(135deg,#1f2937,#374151);
    padding:30px;
    border-radius:14px;
    margin-bottom:14px;
}
header h1{
    color:#84cc16;
    font-size:32px;
}
.subtitle{
    color:#d1d5db;
    margin-top:6px;
}

/* ====== FILTER ====== */
.filter-bar{
    margin:10px 0 18px 0;
}
.filter-bar select{
    padding:10px 14px;
    border-radius:10px;
    border:2px solid #e5e7eb;
    font-size:14px;
    font-weight:600;
}

/* ====== KPIs (SIN CAMBIOS VISUALES) ====== */
.kpi-grid{
    display:grid;
    grid-template-columns:repeat(6,1fr);
    gap:16px;
}
.kpi-card{
    background:#ffffff;
    border:2px solid #e5e7eb;
    border-radius:12px;
    padding:16px;
}
.kpi-card.highlight{border-left:4px solid #84cc16}
.kpi-card.warning{border-left:4px solid #f59e0b}

.kpi-label{
    font-size:11px;
    font-weight:600;
    color:#6b7280;
    text-transform:uppercase;
    margin-bottom:6px;
}
.kpi-value{
    font-size:22px;
    font-weight:700;
}
.kpi-value.highlight{color:#84cc16}
.kpi-subvalue{
    font-size:11px;
    color:#9ca3af;
}

/* ====== GR√ÅFICAS ====== */
.chart-container {
    background:#ffffff;
    border:2px solid #e5e7eb;
    border-radius:12px;
    padding:20px;
    margin-top:20px;
}

.row-charts{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:20px;
}

/* ====== TABLAS ====== */
.tables-grid{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:20px;
    margin-top:20px;
}

table{
    width:100%;
    border-collapse:collapse;
}
th,td{
    border:1px solid #e5e7eb;
    padding:8px;
    font-size:12px;
}
th{
    background:#1f2937;
    color:white;
}
</style>
</head>

<body>

<aside class="sidebar">
    <h2>Traxion</h2>
    <div class="menu-item active" id="menu-km">üöõ Kil√≥metros</div>
    <div class="menu-item" id="menu-flota">üöó Flota Vehicular</div>
</aside>

<main class="content">
<div class="container">

<section id="view-kilometros">

<header>
    <h1>Dashboard de Kil√≥metros Recorridos</h1>
    <p class="subtitle" id="headerPeriodo"></p>
</header>

<div class="filter-bar">
    <select id="unidadNegocio">
        <option value="SETTEPI SALTILLO">SETTEPI SALTILLO</option>
        <option value="LIPU SALTILLO">LIPU SALTILLO</option>
    </select>
</div>

<!-- ====== KPIs (TAL CUAL LOS TEN√çAS) ====== -->
<div class="kpi-grid">
    <div class="kpi-card highlight">
        <div class="kpi-label">TOTAL KM RECORRIDOS</div>
        <div class="kpi-value highlight" id="kpiTotal">0 km</div>
        <div class="kpi-subvalue">Acumulado del periodo</div>
    </div>

    <div class="kpi-card">
        <div class="kpi-label">KM PERMITIDOS</div>
        <div class="kpi-value" id="kpiPermitido">0 km</div>
        <div class="kpi-subvalue">L√≠mite establecido</div>
    </div>

    <div class="kpi-card highlight">
        <div class="kpi-label">MARGEN DISPONIBLE</div>
        <div class="kpi-value highlight" id="kpiMargen">0 km</div>
        <div class="kpi-subvalue" id="txtMargen"></div>
    </div>

    <div class="kpi-card">
        <div class="kpi-label">KM DE SERVICIO</div>
        <div class="kpi-value" id="kpiServicio">0 km</div>
        <div class="kpi-subvalue" id="pctServicio"></div>
    </div>

    <div class="kpi-card">
        <div class="kpi-label">KM MTTO / CARGA / RH / SEG</div>
        <div class="kpi-value" id="kpiMtto">0 km</div>
        <div class="kpi-subvalue" id="pctMtto"></div>
    </div>

    <div class="kpi-card warning">
        <div class="kpi-label">KM INEFICIENTE (VAC√çO)</div>
        <div class="kpi-value" id="kpiVacio">0 km</div>
        <div class="kpi-subvalue" id="pctVacio"></div>
    </div>
</div>

<!-- ====== GR√ÅFICA 1 (M√ÅS PEQUE√ëA) ====== -->
<div class="chart-container" style="max-width:900px;">
    <h3>Progreso Acumulado (Real vs Permitido Diario)</h3>
    <canvas id="chartProgreso"></canvas>
</div>

<!-- ====== GR√ÅFICAS ABAJO (PIE + L√çNEAS) ====== -->
<div class="row-charts">
    <div class="chart-container">
        <h3>Distribuci√≥n Total del Periodo</h3>
        <canvas id="chartPie"></canvas>
    </div>

    <div class="chart-container">
        <h3>Comportamiento Diario por Tipo de KM</h3>
        <canvas id="chartLineas"></canvas>
    </div>
</div>

<!-- ====== TABLAS ====== -->
<div class="tables-grid">

<div class="chart-container">
<h3>Por Gerente</h3>
<table>
<thead><tr><th>Gerente</th><th>Km Totales</th></tr></thead>
<tbody id="tablaGerente"></tbody>
</table>
</div>

<div class="chart-container">
<h3>Por Jefe</h3>
<table>
<thead><tr><th>Jefe</th><th>Km Totales</th></tr></thead>
<tbody id="tablaJefe"></tbody>
</table>
</div>

<div class="chart-container">
<h3>Por Cliente</h3>
<table>
<thead><tr><th>Cliente</th><th>Km Totales</th></tr></thead>
<tbody id="tablaCliente"></tbody>
</table>
</div>

</div>

</section>
</div>
</main>

<script>
const SHEET_ID = "1l3QYg7N050BScrtNhKkHQ-hHNDgaK9Prw95Dzb2-DRE";
const SHEET_NAME = "Kilometros";

function num(v){
    if(!v) return 0;
    return Number(v.toString().replace(/,/g,"").trim()) || 0;
}

async function cargarDatos(){
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&sheet=${SHEET_NAME}`;
    const res = await fetch(url);
    const csv = await res.text();
    return new Promise(r=>{
        Papa.parse(csv,{header:false,skipEmptyLines:true,complete:x=>r(x.data)});
    });
}

let chartProgreso, chartPie, chartLineas;

async function actualizar(){
    const unidad = unidadNegocio.value.trim().toUpperCase();
    const rows = await cargarDatos();

    let total=0, servicio=0, mtto=0, vacio=0, permitido=0;
    let datosDiarios = [];

    const hoy = new Date(); hoy.setDate(hoy.getDate()-1);
    const diasMes = new Date(hoy.getFullYear(), hoy.getMonth()+1, 0).getDate();

    let gerentes={}, jefes={}, clientes={};

    rows.forEach(r=>{
        const udnMaestro = (r[0]||"").trim().toUpperCase();
        if(udnMaestro===unidad){
            total += num(r[4]);
            servicio += num(r[5]);
            mtto += num(r[6]);
            vacio += num(r[7]);
            if(!permitido) permitido = num(r[9]);
        }

        const udnDiario = (r[11]||r[19]||"").trim().toUpperCase();
        const dia = num(r[12]||r[20]);

        if(udnDiario===unidad && dia>=1 && dia<=hoy.getDate()){
            let kmTotal, kmServ, kmMtto, kmVac, kmPermitidoDia;

            if(unidad==="SETTEPI SALTILLO"){
                kmTotal = num(r[13]);
                kmServ  = num(r[14]);
                kmMtto  = num(r[15]);
                kmVac   = num(r[16]);
                kmPermitidoDia = num(r[17]); // Col R
            } else {
                kmTotal = num(r[21]);
                kmServ  = num(r[22]);
                kmMtto  = num(r[23]);
                kmVac   = num(r[24]);
                kmPermitidoDia = num(r[25]); // Col Z
            }

            datosDiarios.push({dia,kmTotal,kmServ,kmMtto,kmVac,kmPermitidoDia});

            const gerente = (r[1]||"SIN GERENTE");
            const jefe = (r[2]||"SIN JEFE");
            const cliente = (r[3]||"SIN CLIENTE");

            gerentes[gerente] = (gerentes[gerente]||0) + kmTotal;
            jefes[jefe] = (jefes[jefe]||0) + kmTotal;
            clientes[cliente] = (clientes[cliente]||0) + kmTotal;
        }
    });

    /* ===== KPIs (solo cambia el subtexto del margen) ===== */
    kpiTotal.innerText = total.toLocaleString()+" km";
    kpiServicio.innerText = servicio.toLocaleString()+" km";
    kpiMtto.innerText = mtto.toLocaleString()+" km";
    kpiVacio.innerText = vacio.toLocaleString()+" km";
    kpiPermitido.innerText = permitido.toLocaleString()+" km";

    const margen = permitido-total;
    kpiMargen.innerText = margen.toLocaleString()+" km";

    const pct = permitido?((margen/permitido)*100).toFixed(1):0;
    const importe = (margen*6).toLocaleString("es-MX",{style:"currency",currency:"MXN"});

    txtMargen.innerHTML = `${pct}% de los KM permitidos.<br>Y en importe es: ${importe}`;

    pctServicio.innerText = total?((servicio/total)*100).toFixed(1)+"% del total":"";
    pctMtto.innerText = total?((mtto/total)*100).toFixed(1)+"% del total":"";
    pctVacio.innerText = total?((vacio/total)*100).toFixed(1)+"% del total":"";

    headerPeriodo.innerText = "Periodo al d√≠a "+hoy.getDate();

    /* ===== GRAFICA 1: REAL vs PERMITIDO ACUMULADO ===== */
    datosDiarios.sort((a,b)=>a.dia-b.dia);

    let labels=[], realAc=0, perAc=0, realData=[], perData=[], pctLine=[];

    datosDiarios.forEach(d=>{
        realAc += d.kmTotal;
        perAc += d.kmPermitidoDia;
        labels.push(d.dia);
        realData.push(realAc);
        perData.push(perAc);
        pctLine.push(perAc?((realAc/perAc)*100).toFixed(0):0);
    });

    const ctx1 = document.getElementById("chartProgreso").getContext("2d");
    if(chartProgreso) chartProgreso.destroy();

    chartProgreso = new Chart(ctx1,{
        type:"line",
        data:{labels,datasets:[
            {label:"KM Real Acumulado",data:realData,borderColor:"#84cc16"},
            {label:"KM Permitido Acumulado",data:perData,borderColor:"#1f2937"}
        ]},
        options:{plugins:{
            tooltip:{enabled:false},
            annotation:{annotations:[]}
        }}
    });

    /* ===== GRAFICA PIE ===== */
    const ctx2 = document.getElementById("chartPie").getContext("2d");
    if(chartPie) chartPie.destroy();

    chartPie = new Chart(ctx2,{
        type:"pie",
        data:{
            labels:["Servicio","Mtto","Vac√≠o"],
            datasets:[{
                data:[servicio,mtto,vacio],
                backgroundColor:["#84cc16","#9ca3af","#f59e0b"]
            }]
        }
    });

    /* ===== GRAFICA LINEAS ===== */
    const ctx3 = document.getElementById("chartLineas").getContext("2d");
    if(chartLineas) chartLineas.destroy();

    chartLineas = new Chart(ctx3,{
        type:"line",
        data:{
            labels,
            datasets:[
                {label:"Servicio",data:datosDiarios.map(d=>d.kmServ),borderColor:"#84cc16"},
                {label:"Mtto",data:datosDiarios.map(d=>d.kmMtto),borderColor:"#9ca3af"},
                {label:"Vac√≠o",data:datosDiarios.map(d=>d.kmVac),borderColor:"#f59e0b"}
            ]
        }
    });

    /* ===== TABLAS ===== */
    tablaGerente.innerHTML = Object.entries(gerentes)
        .map(([g,k])=>`<tr><td>${g}</td><td>${k.toLocaleString()} km</td></tr>`).join("");

    tablaJefe.innerHTML = Object.entries(jefes)
        .map(([g,k])=>`<tr><td>${g}</td><td>${k.toLocaleString()} km</td></tr>`).join("");

    tablaCliente.innerHTML = Object.entries(clientes)
        .map(([g,k])=>`<tr><td>${g}</td><td>${k.toLocaleString()} km</td></tr>`).join("");
}

unidadNegocio.addEventListener("change",actualizar);
actualizar();
</script>

</body>
</html>
